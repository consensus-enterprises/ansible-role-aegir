---
- name: "'Unit-test' playbook."
  hosts: all

  tasks:

  - name: Include default variables, since we call task includes separately.
    include_vars:
      file: consensus.aegir/defaults/main.yml

  ### Dependencies ###

  - name: Include dependency installation tasks.
    include: ../tasks/dependencies.yml
    vars:
      aegir_http_service_type: nginx
      aegir_php_version: 7

  - name: Check that dependency packages are installed
    shell: "dpkg -l|grep '^ii  {{ item }}'"
    loop: "{{ aegir_dependencies + aegir_dependencies_php7 + aegir_dependencies_nginx_php7 }}"
    changed_when: False

  ### User and group ###

  - name: Include user creation tasks.
    include: ../tasks/git/user.yml

  - name: Check that 'aegir' user exists.
    shell: "getent passwd aegir"
    changed_when: False

  - name: Check that 'aegir' group exists.
    shell: "getent group aegir"
    changed_when: False

  - name: Check that 'aegir' home directory exists.
    shell: "[ -d /var/aegir ]"
    changed_when: False

  - name: Check that 'aegir' Drush directory exists.
    shell: "[ -d /var/aegir/.drush ]"
    changed_when: False

  ### Composer/Drush/Provision installation ###

  - name: Include Composer install tasks.
    include: ../tasks/composer.yml

  - name: Check that Composer is installed.
    shell: "composer"
    changed_when: False

  - name: Include Drush install tasks.
    include: ../tasks/git/drush.yml
    vars:
      aegir_drush_install_method: git

  - name: Check that Drush is installed.
    shell: "drush status"
    changed_when: False

  - name: Include Provision install tasks.
    include: ../tasks/git/provision.yml

  - name: Check that Provision is installed.
    shell: "[ -d /var/aegir/.drush/provision ]"
    changed_when: False

  ### Nginx setup ###

  - name: Include Nginx setup tasks.
    include: ../tasks/git/setup-nginx.yml

  - name: Check that Nginx config file exists.
    shell: "[ -f /etc/nginx/conf.d/aegir.conf ]"
    changed_when: False

  ### Sudo setup ###

  - name: Setup sudo for aegir user.
    include: ../tasks/git/sudo.yml

  - name: Check that sudo config file exists.
    shell: "[ -f /etc/sudoers.d/aegir ]"
    changed_when: False
    become: yes
