---
- name: "'Unit-test' playbook."
  hosts: all

  tasks:

  - name: Include default variables, since we call task includes separately.
    include_vars:
      file: consensus.aegir/defaults/main.yml

  ### Dependencies ###

  - name: Include dependency installation tasks.
    include: ../tasks/dependencies.yml
    vars:
      aegir_http_service_type: nginx
      aegir_php_version: 7

  - name: Check that dependency packages are installed
    shell: "dpkg -l|grep '^ii  {{ item }}'"
    loop: "{{ aegir_dependencies + aegir_dependencies_php7 + aegir_dependencies_nginx_php7 }}"
    changed_when: False

  ### User and group ###

  - name: Include user creation tasks.
    include: ../tasks/git/user.yml

  - name: Check that 'aegir' user exists.
    shell: "getent passwd aegir"
    changed_when: False

  - name: Check that 'aegir' group exists.
    shell: "getent group aegir"
    changed_when: False

  - name: Check that 'aegir' home directory exists.
    shell: "[ -d /var/aegir ]"
    changed_when: False

  - name: Check that 'aegir' Drush directory exists.
    shell: "[ -d /var/aegir/.drush ]"
    changed_when: False

  ### Drush/Provision installation ###

  - name: Include Drush install tasks.
    include: ../tasks/git/drush.yml
    vars:
      aegir_drush_install_method: git

  - name: Check that Drush is installed.
    shell: "drush status"
    changed_when: False

  - name: Include Provision install tasks.
    include: ../tasks/git/provision.yml

  - name: Check that Provision is installed.
    shell: "[ -d /var/aegir/.drush/provision ]"
    changed_when: False

  ### Nginx setup ###

  - name: Include Nginx setup tasks.
    include: ../tasks/git/setup-nginx.yml

  - name: Check that Nginx config file exists.
    shell: "[ -L /etc/nginx/conf.d/aegir.conf ]"
    changed_when: False

  ### Sudo setup ###

  - name: Setup sudo for aegir user.
    include: ../tasks/git/sudo.yml

  - name: Check that sudo config file exists.
    shell: "[ -f /etc/sudoers.d/aegir ]"
    changed_when: False
    become: yes

  ### Aegir global include setup ###

  - name: Setup global include file.
    include: ../tasks/global.yml
    vars:
      aegir_https_proxy_ip_range: "192.168.177.0/24"

  - name: Confirm that Aegir global include file contains proxy support.
    shell: "grep '192.168.177.0/24' /var/aegir/config/includes/global.inc"
    changed_when: False


  ### Aegir Drush makefile ###

  - name: Ensure that test makefile doesn't exist.
    file:
      path: '/etc/aegir/aegir.make.yml'
      state: absent
    changed_when: False
    become: yes

  - name: Deploy Aegir Drush makefile.
    include: ../tasks/makefile.yml

  - name: Confirm custom Aegir Drush makefile does not exist.
    shell: "[ ! -f /etc/aegir/aegir.make.yml ]"
    changed_when: False

  - name: Deploy custom Aegir Drush makefile.
    include: ../tasks/makefile.yml
    vars:
      aegir_generate_makefile: yes

  - name: Check that custom Aegir Drush makefile exists.
    shell: "[ -f /etc/aegir/aegir.make.yml ]"
    changed_when: False
    become: yes

  ### Aegir Drush makefile debconf settings ###

  - name: Install debconf utilities.
    include: ../tasks/deb/utils.yml

  - name: Clear any existing debconf selections for Aegir Drush makefile.
    shell: "debconf-get-selections | grep -v aegir/makefile || echo UNREGISTER aegir/makefile | debconf-communicate aegir3-hostmaster"
    changed_when: False
    become: yes

  - name: Override Debian package config with defaults.
    include: ../tasks/deb/debconf.yml

  - name: Check that debconf will use default Aegir Drush makefile.
    shell: "debconf-get-selections | grep -v aegir/makefile"
    changed_when: False
    become: yes

  - name: Override Debian package config to use custom Aegir Drush makefile.
    include: ../tasks/deb/debconf.yml
    vars:
      generate_makefile: yes

  - name: Check that debconf will use custom Aegir Drush makefile.
    shell: "debconf-get-selections | grep aegir/makefile"
    changed_when: False
    become: yes

