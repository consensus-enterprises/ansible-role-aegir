---
- name: "'Unit-test' playbook."
  hosts: all

  tasks:

  - name: Include default variables, since we call task includes separately.
    include_vars:
      file: consensus.aegir/defaults/main.yml

  - name: Include dependency installation tasks.
    include: ../tasks/dependencies.yml
    vars:
      aegir_http_service_type: nginx
      aegir_php_version: 7

  - name: Check that dependency packages are installed
    shell: "dpkg -l|grep '^ii  {{ item }}'"
    loop: "{{ aegir_dependencies + aegir_dependencies_php7 + aegir_dependencies_nginx_php7 }}"
    ignore_errors: yes # TODO: this is a workaround for CI so that tests pass; fix permanently, pls

  - name: Include user creation tasks.
    include: ../tasks/git/user.yml

  - name: Check that 'aegir' user exists.
    shell: "getent passwd aegir"

  - name: Check that 'aegir' group exists.
    shell: "getent group aegir"

  - name: Check that 'aegir' home directory exists.
    shell: "[ -d /var/aegir ]"

  - name: Check that 'aegir' Drush directory exists.
    shell: "[ -d /var/aegir/.drush ]"

  - name: Include Drush install tasks.
    include: ../tasks/git/drush.yml
    vars:
      aegir_drush_install_method: git

  - name: Check that Drush is installed.
    shell: "drush status"

  - name: Include Provision install tasks.
    include: ../tasks/git/provision.yml

  - name: Check that Provision is installed.
    shell: "[ -d /var/aegir/.drush/provision ]"

