---

- name: Deploy Aegir Drush makefile from template.
  include: ../../tasks/makefile.yml
  vars:
    aegir_generate_makefile: yes

- name: Check that one of our module customizations was recorded in the generated Aegir Drush makefile.
  shell: "grep 'https://gitlab.com/consensus.enterprises/aegir/hosting_skynet.git' /etc/aegir/aegir.make.yml"
  changed_when: false

- name: Build a platform using generated Aegir Drush makefile.
  include: ../../tasks/git/platform.yml
  vars:
    # We set this to the current Unix timestamp to ensure a new platform is
    # always built.
    aegir_platform_version: "default-{{ ansible_facts.date_time.epoch }}"

- name: Check that our custom module is using the correct branch/tag.
  shell: "git symbolic-ref -q --short HEAD || git describe --tags --exact-match| grep 'master'"
  args:
    chdir: "{{ aegir_root }}/hostmaster-default-{{ ansible_facts.date_time.epoch }}/sites/all/modules/hosting_skynet"
  changed_when: False
  become: yes
  become_user: "aegir"

# TODO: tests to write
#
# - perform an include, with passed-in vars 
# - then check that we can configure custom repos per module
# - try adding a brand new module, too (same test? separate one?)
# - perform an include, with passed-in new release var 
# - then check that this customized version was configured in makefile
