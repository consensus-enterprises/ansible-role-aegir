---

- name: Clone Drush from GitHub.
  git:
    repo: "{{ aegir_drush_source_repo }}"
    dest: "{{ aegir_drush_source_install_path }}"
    version: "{{ aegir_drush_source_install_version }}"
    update: "{{ aegir_drush_keep_updated }}"
    force: "{{ aegir_drush_force_update }}"
    depth: "{{ aegir_drush_clone_depth }}"
  register: drush_clone_result
  become: yes

- name: Run Drush updates.
  when: drush_clone_result.changed
  block:
  - name: Wait for tasks in the Aegir queue to complete so we can update Drush safely.
    shell: drush @hostmaster hosting-pause
    become: yes
    become_user: "{{ aegir_user }}"
  - name: Install Drush dependencies with Composer.
    command: "composer install --prefer-dist --no-interaction"
    args:
      chdir: "{{ aegir_drush_source_install_path }}"
    become: yes
  - name: Create drush symlink.
    file:
      src: "{{ aegir_drush_source_install_path }}/drush"
      dest: "{{ aegir_drush_source_install_bin_path }}"
      state: link
      force: true
    become: yes
    notify:
      - Clear Drush cache
      - Clear Aegir front-end Drush cache
      - Verify Aegir front-end
      - Restart the queue daemon
    when: drush_clone_result.changed
  - name: Force handlers to run if necessary.
    meta: flush_handlers
  - name: Run drush to finish setting it up.
    command: "{{ aegir_drush_source_install_bin_path }}"
    register: drush_result
    changed_when: "'Execute a drush command' not in drush_result.stdout"
    become: false
